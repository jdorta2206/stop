
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Reglas para la colección 'users'
    match /users/{userId} {
      // Cualquiera puede leer los perfiles de usuario (para buscar amigos, ver rankings).
      // Solo el dueño del perfil puede actualizar su propia información.
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;

      // Reglas para subcolecciones de 'friends'
      match /friends/{friendId} {
        // Solo el dueño del perfil puede leer y escribir su lista de amigos.
        allow read, write: if request.auth.uid == userId;
      }
      
      // Reglas para subcolecciones de 'notifications'
      match /notifications/{notificationId} {
         // Cualquiera puede crear una notificación para un usuario (enviar invitación).
        allow create: if request.auth != null;
        // Solo el dueño del perfil puede leer, actualizar o borrar sus notificaciones.
        allow read, update, delete: if request.auth.uid == userId;
      }

      // Reglas para subcolecciones de 'gameHistory'
      match /gameHistory/{gameId} {
        // Solo el dueño del perfil puede crear su historial de juego.
        allow create: if request.auth.uid == userId;
        // El historial es privado, solo el dueño puede leerlo.
        allow read: if request.auth.uid == userId;
      }
    }
    
    // Reglas para la colección 'rooms'
    match /rooms/{roomId} {
      // Cualquiera que esté autenticado puede leer una sala (para ver jugadores, estado).
      allow read: if request.auth != null;
      // Cualquiera que esté autenticado puede crear una sala.
      allow create: if request.auth != null;
      // Para actualizar, el usuario debe estar autenticado y su ID debe estar en la lista de jugadores de la sala.
      allow update: if request.auth != null && request.auth.uid in resource.data.players;
    }
  }
}
