
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Perfiles de Jugadores y Ranking
    match /rankings/{userId} {
      // Cualquier usuario autenticado puede leer los perfiles (necesario para buscar e invitar).
      allow get, list: if request.auth != null;
      
      // Solo el propietario del perfil puede crear, actualizar o borrar su propio documento.
      allow create, update, delete: if request.auth.uid == userId;

      // Historial de partidas: solo el propietario puede acceder a su historial.
      match /gameHistory/{gameId} {
        allow read, write: if request.auth.uid == userId;
      }
      
      // Amigos: solo el propietario puede gestionar su lista de amigos.
      match /friends/{friendId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    // Salas de Juego
    match /rooms/{roomId} {
      // Cualquiera puede leer los datos de una sala para unirse y jugar.
      // La escritura se controla por lógica en el servidor (Cloud Functions o server-side logic).
      // Aquí permitimos la escritura a cualquier usuario autenticado para que puedan actualizar su estado.
      allow read, write: if request.auth != null;

      // Chat de la sala
      match /chat/{messageId} {
        allow read, create: if request.auth != null;
      }
    }
    
    // Notificaciones: Cualquier usuario autenticado puede crear notificaciones (enviar invitaciones).
    match /notifications/{notificationId} {
      allow create: if request.auth != null;
      // Solo el destinatario puede leer o actualizar su notificación (para marcarla como leída/aceptada).
      allow read, update: if request.auth.uid == resource.data.recipientId;
    }
  }
}
